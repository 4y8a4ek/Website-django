{% load static custom_filters %}
{% get_media_prefix as media_url %}
{% now "U" as timestamp %}


<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ course.title }}</title>
    <link rel="stylesheet" href="{% static 'css/course_detail.css' %}?v={{ timestamp }}">
    <link href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-okaidia.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"></script>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            }
        });

        function toggleProfileMenu(event) {
            event.preventDefault();
            const menu = document.querySelector('.profile-dropdown');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function closeModal() {
            document.getElementById('feedback-modal').classList.remove('show');
        }
    </script>
</head>
<body>

<!-- –ù–∞–≤–±–∞—Ä -->
<div class="navbar">
    <a href="/" class="logo-link">
        <img src="{% static 'images/logo.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo-img">
    </a>
    <a href="/" class="home-btn">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="/courses" class="home-btn">–ö—É—Ä—Å—ã</a>
    {% if user.is_authenticated %}
    <div class="profile-menu">
        <a href="#" class="home-btn" onclick="toggleProfileMenu(event)">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <div class="profile-dropdown">
            <img src="{{ profile.photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä">
            <p><strong>{{ user.name }}</strong></p>
            <p>‚≠ê Stars: {{ profile.stars }}</p>
            <p>üî• EXP: {{ profile.exp }}</p>
            <a href="{% url 'profile_app:profile' %}" class="profile-btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
    {% endif %}
    <button class="theme-btn" onclick="toggleTheme()">üåì</button>
</div>

<div class="container">
    <h2>{{ course.title }}</h2>
    <p>{{ course.description }}</p>

    <div class="progress-bar-wrapper">
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ progress }}%"></div>
        </div>
        <div class="progress-text">{{ progress }}%</div>
    </div>

    <div class="course-grid">
        <!-- –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="course-toc">
            <h3>üìö –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h3>
            {% for section in sections %}
                <form method="post" style="margin: 0;">
    {% csrf_token %}
    {% if not section_locked|index:forloop.counter0 %}
        <button type="submit" name="jump_to_section" value="{{ forloop.counter0 }}" class="section-title-link">
            ‚úÖ {{ section.title }}
        </button>
    {% else %}
        <div class="section-title locked">
            üîí {{ section.title }}
        </div>
    {% endif %}
</form>

            {% endfor %}
        </div>

        <div class="course-content">
            <div class="content-inner">
                {% if current_content.type == 'theory' %}
                    <h3 class = "title">{{ current_content.title }}</h3>
                    {% if current_content.image %}
                        <div class="course-image-wrapper">
                            <img src="{{ media_url }}{{ current_content.image }}" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–ª–æ–∫–∞" class="course-image">
                        </div>
                    {% endif %}
                    <p>{{ current_content.text|safe }}</p>                   

                {% elif current_content.type == 'test' %}
                    {% if completed >= current_block_index %}
                        <h3 class = "title">{{ current_content.question|safe}}</h3> 
                <div class="correct-answer">
                    <div class="ans-blc">
                        <p class="corr">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</p>
                        <ul >
                            {% if current_content.test_type == 'ordering' %}
                                {% for i in current_content.correct %}
                                    <li>{{ current_content.shuffled_options|index:i }}</li>
                                {% endfor %}
                            {% elif current_content.test_type == 'text_input' %}
                                <li>{{ current_content.correct }}</li>
                            {% else %}
                                {% for i in current_content.correct %}
                                    <li>{{ current_content.options|index:i|linebreaksbr }}</li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                        <img id="sad-rabbit-img" class="sad-rabbit-image" src="" alt="Happy Rabbit" />
                        <script>
                            const images = [
                                "{{ media_url }}happy_rabbit/1.png",
                                "{{ media_url }}happy_rabbit/2.png",
                                "{{ media_url }}happy_rabbit/3.png",
                                "{{ media_url }}happy_rabbit/4.png",
                                "{{ media_url }}happy_rabbit/5.png",
                                "{{ media_url }}happy_rabbit/6.png",
                                "{{ media_url }}happy_rabbit/7.png",
                                "{{ media_url }}happy_rabbit/8.png",
                                "{{ media_url }}happy_rabbit/9.png",
                                "{{ media_url }}happy_rabbit/10.png",
                                "{{ media_url }}happy_rabbit/11.png",
                                "{{ media_url }}happy_rabbit/12.png",
                                "{{ media_url }}happy_rabbit/13.png",
                                "{{ media_url }}happy_rabbit/14.png"

                            ];
                            const randomImage = images[Math.floor(Math.random() * images.length)];
                            const imgElement = document.getElementById("sad-rabbit-img");
                            imgElement.src = randomImage;
                            imgElement.onload = function() {
                                imgElement.style.maxWidth = "200px";
                                imgElement.style.maxHeight = "200px";
                                imgElement.style.marginTop = "10px";
                            }
                        </script>
                    </div>
                    {% else %}
                        <form method="post">
                            {% csrf_token %}
                            <h3 class = "title">{{ current_content.question|safe}}</h3>
                            <div class="answer-block">
                                {% if current_content.test_type == 'single_choice' %}
                                    {% for opt in current_content.options %}
                                        <label class="answer-option">
                                            <input type="radio" name="answer" value="{{ forloop.counter0 }}"> {{ opt|linebreaksbr }}
                                        </label>
                                    {% endfor %}
                                {% elif current_content.test_type == 'multiple_choice' %}
                                    {% for opt in current_content.options %}
                                        <label class="answer-option">
                                            <input type="checkbox" name="answer" value="{{ forloop.counter0 }}"> {{ opt|linebreaksbr }}
                                        </label>
                                    {% endfor %}
                                {% elif current_content.test_type == 'ordering' %}
                                    <p>–í–≤–µ–¥–∏—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2,0,1)</p>
                                    <ul>
                                        {% for opt in current_content.shuffled_options %}
                                            <li>{{ forloop.counter0 }}: {{ opt|linebreaksbr }}</li>
                                        {% endfor %}
                                    </ul>
                                    <input type="text" name="answer" class="answer-input">
                                {% elif current_content.test_type == 'text_input' %}
                                    <p>{{ current_content.text|safe }}</p>
                                    <input type="text" name="answer" class="answer-input">
                                {% elif current_content.test_type == 'matching' %}
                                    <div class="matching-grid">
                                        <div class="matching-column">
                                            <h4>–õ–µ–≤–∞—è —á–∞—Å—Ç—å</h4>
                                            {% for left in current_content.left %}
                                                <p>{{ forloop.counter }}. {{ left }}</p>
                                            {% endfor %}
                                        </div>
                                        <div class="matching-column">
                                            <h4>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</h4>
                                            {% for left in current_content.left %}
                                                <select name="match_{{ forloop.counter0 }}" class="answer-input">
                                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                                                    {% for opt in current_content.right %}
                                                        <option value="{{ opt|linebreaksbr }}">{{ opt|linebreaksbr }}</option>
                                                    {% endfor %}
                                                </select>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            <button type="submit" name="submit_answer" class="submit-button">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                        </form>
                    {% endif %}
                {% endif %}
        
                {% if messages %}
                    <div class="messages-container">
                        {% for message in messages %}
                            {% if message.tags == 'error' %}
                                <div class="error-message">
                                    <p class = "incor">–û—Ç–≤–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–ø—ã—Ç–∫—É</p>
                                    <img id="sad-rabbit-img" class="sad-rabbit-image" src="" alt="Sad Rabbit" />
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <script>
                        const images = [
                            "{{ media_url }}sad_rabbit/1.png",
                            "{{ media_url }}sad_rabbit/2.png",
                            "{{ media_url }}sad_rabbit/3.png",
                            "{{ media_url }}sad_rabbit/4.png"
                        ];
                        const randomImage = images[Math.floor(Math.random() * images.length)];
                        const imgElement = document.getElementById("sad-rabbit-img");
                        imgElement.src = randomImage;
                        imgElement.onload = function() {
                            imgElement.style.maxWidth = "200px";
                            imgElement.style.maxHeight = "200px";
                            imgElement.style.marginTop = "10px";
                        }
                    </script>
                {% endif %}
            </div>
        
            <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <div class="nav-buttons">
                <form method="post">
                    {% csrf_token %}
                    {% if can_go_back %}
                        <button type="submit" name="go_back" class="nav-btn">‚Üê –ù–∞–∑–∞–¥</button>
                    {% endif %}
                    {% if can_go_forward %}
                        <button type="submit" name="go_forward" class="nav-btn">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
                    {% endif %}
                </form>
            </div>
        </div>
        
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        {% if messages %}
            const modal = document.getElementById("feedback-modal");
            const msg = document.getElementById("modal-message");
            msg.textContent = "{{ messages.0|escapejs }}";
            msg.className = "message-{{ messages.0.tags }}";
            modal.classList.add("show");
        {% endif %}
    });
</script>

<!-- –§—É—Ç–µ—Ä -->
<footer class="footer">
    <p>¬© 2025 Cr8ate. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    <p><a href="#">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> | <a href="#">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a></p>
</footer>

</body>
</html>
